const puppeteer = require('puppeteer');
var spawn = require('child_process').spawn

const BASE_URL = 'http://localhost:8085/';

function wait(time) {
    const start = Date.now();
    while (true) {
      if (Date.now() - start >= time) {
        return true;
      }
    }
  }

describe('Criar um servidor TCP utilizando o módulo net que exiba no console todo o conteúdo recebido', () => {
  let browser;
  let page;

  beforeEach(async () => {
    browser = await puppeteer.launch({ args: ['--no-sandbox', '--disable-gpu', '--disable-dev-shm-usage', '--window-size=1920,1080'], headless: true });
    page = await browser.newPage();
  });

  afterEach(async () => {
    await page.close();
    await browser.close();
  });

  it('Será validado que ao fazer a request e acessar o chrome irá mostrar os dados no console', async  (done) => {
    const client = spawn('node', ['exploiters/serverExploiter.js']);
    client.stdout.setEncoding('utf8');

    wait(2000);

    await page.goto(BASE_URL);

    wait(2000);

    client.stdout.on('data', function (data) {
      client.kill();
      expect(data).toContain('GET');
      expect(data).toContain('HTTP/1.1');
      expect(data).toContain('Host: localhost:8085');
      expect(data).toContain('User-Agent:');
      expect(data).toContain('Accept:');
      expect(data).toContain('Connection: keep-alive');
      done();
    });
  });
});
